<script>
    var api = null;
    var state = null;
    var dataPrefix = "docs_";
    function log(msg) {
        var b = document.getElementById("log");
        b.textContent += msg + "\n";
        b.scrollTop = b.scrollHeight;
    }
    function loadUsers() {
        api.call("Get", { typeName: "User" }, function(result) {
            var sel = document.getElementById("userSelect");
            sel.innerHTML = "";
            for (var i = 0; i < result.length; i++) {
                var u = result[i];
                var opt = document.createElement("option");
                opt.value = u.id;
                opt.textContent = u.name || (u.firstName || "") + " " + (u.lastName || "");
                sel.appendChild(opt);
            }
        }, function(err) {
            log("Error cargando usuarios: " + JSON.stringify(err));
        });
    }
    function loadAllDocuments(callback) {
        api.call("GetAddInData", {}, function(result) {
            var all = {};
            for (var i = 0; i < result.length; i++) {
                var row = result[i];
                if (!row.key || row.key.indexOf(dataPrefix) !== 0) continue;
                var userId = row.key.substring(dataPrefix.length);
                try {
                    var parsed = JSON.parse(row.value);
                    if (parsed && Array.isArray(parsed.documentos)) {
                        all[userId] = parsed.documentos;
                    } else {
                        all[userId] = [];
                    }
                } catch (e) {
                    all[userId] = [];
                }
            }
            renderStoredDocs(all);
            if (typeof callback === "function") callback(all);
        }, function(err) {
            log("Error leyendo AddInData: " + JSON.stringify(err));
            renderStoredDocs({});
            if (typeof callback === "function") callback({});
        });
    }
    function renderStoredDocs(store) {
        var box = document.getElementById("storedDocs");
        box.innerHTML = "";
        var now = new Date();
        var userIds = Object.keys(store).sort();
        if (userIds.length === 0) {
            var e = document.createElement("div");
            e.className = "small";
            e.textContent = "No hay documentos almacenados.";
            box.appendChild(e);
            return;
        }
        for (var i = 0; i < userIds.length; i++) {
            var uid = userIds[i];
            var docs = store[uid] || [];
            var title = document.createElement("div");
            title.className = "groupTitle";
            title.textContent = uid;
            box.appendChild(title);
            docs.forEach(function(doc) {
                var item = document.createElement("div");
                var exp = new Date(doc.vence);
                var diff = (exp - now) / (1000 * 60 * 60 * 24);
                if (isNaN(exp.getTime())) diff = 99999;
                if (diff < 0) item.className = "docItem expired";
                else if (diff <= 7) item.className = "docItem soon";
                else item.className = "docItem";
                var left = document.createElement("div");
                left.className = "left";
                left.textContent = doc.nombre + " ";
                var small = document.createElement("span");
                small.className = "small";
                small.textContent = "(" + (doc.vence || "") + ")";
                left.appendChild(small);
                var right = document.createElement("div");
                right.className = "right";
                var btnDel = document.createElement("button");
                btnDel.textContent = "Eliminar";
                btnDel.style.marginLeft = "8px";
                (function(userIdCopy, docCopy, itemEl){
                    btnDel.onclick = function() {
                        deleteDocumentForUser(userIdCopy, docCopy, function(ok){
                            if (ok) {
                                itemEl.parentNode.removeChild(itemEl);
                                log("Documento eliminado");
                                loadAllDocuments();
                            } else {
                                log("Error al eliminar documento");
                            }
                        });
                    };
                })(uid, doc, item);
                right.textContent = humanizeDiff(diff);
                right.appendChild(btnDel);
                item.appendChild(left);
                item.appendChild(right);
                box.appendChild(item);
            });
        }
    }
    function humanizeDiff(days) {
        if (days === 99999) return "Fecha inválida";
        if (days < 0) return "Vencido";
        if (days <= 7) return "Vence en " + Math.ceil(days) + " días";
        return "Vence en " + Math.ceil(days) + " días";
    }
    function saveDocument() {
        var userId = document.getElementById("userSelect").value;
        var nombre = document.getElementById("docName").value.trim();
        var vence = document.getElementById("docDate").value;
        if (!userId || !nombre || !vence) {
            log("Faltan datos para guardar");
            return;
        }
        var key = dataPrefix + userId;
        api.call("GetAddInData", { key: key }, function(res) {
            var docs = { documentos: [] };
            if (res && res.value) {
                try {
                    docs = JSON.parse(res.value);
                    if (!docs.documentos) docs.documentos = [];
                } catch (e) {
                    docs = { documentos: [] };
                }
            }
            docs.documentos.push({ nombre: nombre, vence: vence });
            api.call("SetAddInData", { key: key, value: JSON.stringify(docs) }, function() {
                log("Documento guardado");
                loadAllDocuments();
                clearForm();
            }, function(err) {
                log("Error guardando: " + JSON.stringify(err));
            });
        }, function() {
            var docs = { documentos: [{ nombre: nombre, vence: vence }] };
            api.call("SetAddInData", { key: key, value: JSON.stringify(docs) }, function() {
                log("Documento guardado (nuevo key)");
                loadAllDocuments();
                clearForm();
            }, function(err) {
                log("Error guardando: " + JSON.stringify(err));
            });
        });
    }
    function deleteDocumentForUser(userId, docToDelete, callback) {
        var key = dataPrefix + userId;
        api.call("GetAddInData", { key: key }, function(res) {
            if (!res || !res.value) {
                callback(false);
                return;
            }
            try {
                var parsed = JSON.parse(res.value);
                var arr = parsed.documentos || [];
                var idx = -1;
                for (var i = 0; i < arr.length; i++) {
                    if (arr[i].nombre === docToDelete.nombre && arr[i].vence === docToDelete.vence) {
                        idx = i;
                        break;
                    }
                }
                if (idx === -1) {
                    callback(false);
                    return;
                }
                arr.splice(idx, 1);
                parsed.documentos = arr;
                api.call("SetAddInData", { key: key, value: JSON.stringify(parsed) }, function() {
                    callback(true);
                }, function() {
                    callback(false);
                });
            } catch (e) {
                callback(false);
            }
        }, function() {
            callback(false);
        });
    }
    function clearForm() {
        document.getElementById("docName").value = "";
        document.getElementById("docDate").value = "";
    }
    function processCSVFile(file) {
        var reader = new FileReader();
        reader.onload = function(e) {
            var text = e.target.result;
            var lines = text.split(/\r\n|\n/);
            var processed = 0;
            var errors = 0;
            var chain = Promise.resolve();
            for (var i = 0; i < lines.length; i++) {
                (function(line){
                    chain = chain.then(function(){
                        return new Promise(function(res){
                            var trimmed = line.trim();
                            if (!trimmed) { res(); return; }
                            var cols = parseCSVLine(trimmed);
                            if (cols.length < 3) { errors++; res(); return; }
                            var userId = cols[0].trim();
                            var nombre = cols[1].trim();
                            var vence = cols[2].trim();
                            if (!userId || !nombre || !vence) { errors++; res(); return; }
                            var key = dataPrefix + userId;
                            api.call("GetAddInData", { key: key }, function(resGet) {
                                var docs = { documentos: [] };
                                if (resGet && resGet.value) {
                                    try {
                                        docs = JSON.parse(resGet.value);
                                        if (!docs.documentos) docs.documentos = [];
                                    } catch (e) {
                                        docs = { documentos: [] };
                                    }
                                }
                                docs.documentos.push({ nombre: nombre, vence: vence });
                                api.call("SetAddInData", { key: key, value: JSON.stringify(docs) }, function() {
                                    processed++;
                                    res();
                                }, function() {
                                    errors++;
                                    res();
                                });
                            }, function() {
                                var docs = { documentos: [{ nombre: nombre, vence: vence }] };
                                api.call("SetAddInData", { key: key, value: JSON.stringify(docs) }, function() {
                                    processed++;
                                    res();
                                }, function() {
                                    errors++;
                                    res();
                                });
                            });
                        });
                    });
                })(lines[i]);
            }
            chain.then(function(){
                log("CSV procesado. Registros: " + processed + ", Errores: " + errors);
                loadAllDocuments();
            });
        };
        reader.readAsText(file, "UTF-8");
    }
    function parseCSVLine(line) {
        var res = [];
        var curr = "";
        var inQuotes = false;
        for (var i = 0; i < line.length; i++) {
            var ch = line[i];
            if (ch === '"' ) {
                if (inQuotes && i + 1 < line.length && line[i + 1] === '"') {
                    curr += '"';
                    i++;
                } else {
                    inQuotes = !inQuotes;
                }
            } else if (ch === ',' && !inQuotes) {
                res.push(curr);
                curr = "";
            } else {
                curr += ch;
            }
        }
        res.push(curr);
        return res;
    }
    document.getElementById("saveDoc").onclick = saveDocument;
    document.getElementById("uploadBulk").onclick = function() {
        var f = document.getElementById("bulkFile").files[0];
        if (!f) { log("Seleccione un archivo CSV"); return; }
        processCSVFile(f);
    };
    geotab.addin.driverDocs = function(api_, state_) {
        api = api_;
        state = state_;
        return {
            initialize: function(apiInner, stateInner, callback) {
                loadUsers();
                loadAllDocuments(function(){ callback(); });
            },
            focus: function(apiInner, stateInner) {},
            blur: function() {}
        };
    };
</script>
